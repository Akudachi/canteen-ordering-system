<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Orders - Canteen</title>
<link rel="stylesheet" href="css/style.css">
<style>
body { font-family: Arial, sans-serif; background:#f8f9fa; margin:0; padding:0; }
header { background:#ff4d4d; color:#fff; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; }
header h1 { margin:0; font-size:24px; }
header .btn-group button { background:#fff; color:#ff4d4d; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; font-weight:bold; margin-left:10px; transition:0.3s;}
header .btn-group button:hover { background:#ffe6e6; }

.container { max-width:900px; margin:20px auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
table { width:100%; border-collapse:collapse; font-size:15px; }
th, td { padding:12px; text-align:center; border-bottom:1px solid #eee; }
th { background:#ff4d4d; color:#fff; text-transform:uppercase; letter-spacing:0.5px; }
tr:hover { background:#f9f9f9; }

.status-badge { padding:6px 10px; border-radius:6px; font-weight:bold; font-size:13px; display:inline-block; }
.status-pending { background:#fff3cd; color:#856404; }
.status-paid { background:#d1ecf1; color:#0c5460; }
.status-preparing { background:#cce5ff; color:#004085; }
.status-completed { background:#d4edda; color:#155724; }

#emptyMsg { text-align:center; margin-top:20px; font-size:16px; color:#777; }

#qrModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); justify-content:center; align-items:center; }
#qrModalContent { background:#fff; padding:20px; border-radius:12px; text-align:center; }
#qrModalContent img { max-width:250px; margin-bottom:15px; }
#qrModalContent button { background:#28a745; color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }
</style>
</head>
<body>

<header>
    <h1>My Orders</h1>
    <div class="btn-group">
        <button onclick="viewMenu()">View Menu</button>
        <button onclick="logout()">Logout</button>
    </div>
</header>

<div class="container">
    <table id="ordersTable">
        <thead>
            <tr>
                <th>#</th>
                <th>Order ID</th>
                <th>Items</th>
                <th>Total (₹)</th>
                <th>Status</th>
                <th>Ordered At</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <div id="emptyMsg">You have no orders yet 🛒</div>
</div>

<!-- QR Modal -->
<div id="qrModal">
    <div id="qrModalContent">
        <h3>Scan to Pay</h3>
        <img id="qrImg" src="" alt="UPI QR Code">
        <br>
        <button onclick="closeQR()">Close</button>
    </div>
</div>

<script>
const userEmail = localStorage.getItem("userEmail");
if(!userEmail){ 
    alert("Please login first."); 
    window.location.href="login.html"; 
}

function logout(){
    localStorage.removeItem("userEmail");
    localStorage.removeItem("cart");
    window.location.href="login.html";
}
function viewMenu(){ window.location.href = "home.html"; }

function showQR(qrData){ 
    document.getElementById("qrImg").src = qrData;
    document.getElementById("qrModal").style.display = "flex";
}
function closeQR(){ document.getElementById("qrModal").style.display = "none"; }

async function confirmPayment(orderId){
    try{
        const res = await fetch("/order/confirm", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ orderId, email: userEmail })
        });
        const data = await res.json();
        if(res.ok){ 
            alert("Payment confirmed ✅"); 
            loadOrders(); 
        } else { 
            alert(data.msg || "Payment confirmation failed ⚠️"); 
        }
    } catch(err){ 
        console.error(err); 
        alert("Server error ⚠️"); 
    }
}

async function loadOrders(){
    try{
        const res = await fetch(`/student/orders?email=${userEmail}`);
        const userOrders = await res.json();

        // Sort newest first
        userOrders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        const tbody = document.querySelector("#ordersTable tbody");
        tbody.innerHTML = "";

        if(userOrders.length === 0){
            document.getElementById("ordersTable").style.display="none";
            document.getElementById("emptyMsg").style.display="block";
            return;
        }

        document.getElementById("ordersTable").style.display="table";
        document.getElementById("emptyMsg").style.display="none";

        userOrders.forEach((o, index)=>{
            const tr = document.createElement("tr");

            let statusContent = `<span class="status-badge status-${o.status.toLowerCase()}">${o.status}</span>`;
            if(o.status === "Pending" && o.qrCode){
                statusContent = `
                    <button onclick="showQR('${o.qrCode}')" style="margin-bottom:5px;">Pay</button>
                    <br>
                    <button onclick="confirmPayment(${o.id})" style="padding:5px 10px; border:none; border-radius:5px; background:#28a745; color:#fff; cursor:pointer;">Confirm Payment</button>
                `;
            }

            tr.innerHTML = `
                <td>${index + 1}</td>
                <td>${o.id}</td>
                <td>${o.items.map(i=>i.name).join(", ")}</td>
                <td>₹${o.totalAmount}</td>
                <td>${statusContent}</td>
                <td>${new Date(o.createdAt).toLocaleString()}</td>
            `;
            tbody.appendChild(tr);
        });

    } catch(err){ 
        console.error("Error loading orders:", err); 
    }
}

// Initial load + refresh every 5 seconds
loadOrders();
setInterval(loadOrders, 5000);
</script>

</body>
</html>
