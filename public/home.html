<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Home - Canteen</title>
<link rel="stylesheet" href="css/style.css">
<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; text-align: center; }
h1 { color: #333; }
.menu-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
.menu-item { background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s; }
.menu-item:hover { transform: scale(1.03); }
.menu-item h3 { margin: 0 0 10px; }
.menu-item p { margin: 0 0 10px; font-weight: bold; color: #555; }
.primary { background: #007bff; border: none; color: white; padding: 8px 15px; border-radius: 6px; cursor: pointer; }
.primary:hover { background: #0056b3; }
.top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.top-bar button { background: #28a745; color: #fff; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-left: 5px; }
.shop-status { font-weight: bold; color: #ff4d4d; }
</style>
</head>
<body>

<div class="top-bar">
  <div>Welcome, <span id="studentName"></span></div>
  <div>
    <span class="shop-status" id="shopStatus">Loading...</span>
    <button onclick="window.location.href='cart.html'">Cart üõí</button>
    <button onclick="window.location.href='orders.html'">My Orders</button>
    <button onclick="logout()">Logout</button>
  </div>
</div>

<h1>üç¥ Canteen Menu</h1>
<div class="menu-container" id="menuContainer"></div>

<script>
const studentName = localStorage.getItem("userName");
const userEmail = localStorage.getItem("userEmail");
if(!userEmail) { window.location.href = "login.html"; }
document.getElementById("studentName").textContent = studentName || "Student";

let cart = JSON.parse(localStorage.getItem("cart") || "[]");
let shopStatus = { isOpen: false, acceptingOrders: true };

function logout() { 
  localStorage.clear();
  window.location.href="login.html";
}

// Load menu and shop status
async function loadMenu() {
  try {
    const [menuRes, statusRes] = await Promise.all([
      fetch("/menu"),
      fetch("/shop/status")
    ]);

    const menu = await menuRes.json();
    shopStatus = await statusRes.json();

    const statusText = !shopStatus.isOpen ? "Shop Closed" : (shopStatus.acceptingOrders ? "Open & Accepting Orders" : "Open but not Accepting Orders");
    document.getElementById("shopStatus").textContent = statusText;

    const container = document.getElementById("menuContainer");
    container.innerHTML = "";

    menu.forEach(item => {
      const div = document.createElement("div");
      div.className = "menu-item";
      div.innerHTML = `<h3>${item.name}</h3>
                       <p>‚Çπ${item.price}</p>
                       <button class="primary" onclick='addToCart(${item.id}, "${item.name}", ${item.price})'>Add to Cart</button>`;
      container.appendChild(div);
    });
  } catch(err) {
    console.error("Error loading menu:", err);
  }
}

// Add item to cart
function addToCart(id, name, price) {
  if (!shopStatus.isOpen) { alert("Shop is closed ‚ùå"); return; }
  if (!shopStatus.acceptingOrders) { alert("Orders are currently paused ‚ùå"); return; }

  cart.push({id, name, price});
  localStorage.setItem("cart", JSON.stringify(cart));
  alert(`${name} added to cart ‚úÖ`);
}

// Auto-refresh menu every 5 seconds
setInterval(loadMenu, 1000);

// Initial load
loadMenu();
</script>

</body>
</html>
